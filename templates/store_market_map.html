<!DOCTYPE html>
<html>
<head>
  <title>Store → Market Mapping</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-auth-compat.js"></script>
</head>

<body class="bg-gray-100 p-8">

  <!-- LOGIN SCREEN -->
  <div id="loginDiv" class="flex flex-col items-center">
    <h1 class="text-3xl font-bold mb-6">Login</h1>
    <button id="loginBtn"
      class="px-6 py-3 bg-blue-600 text-white rounded">
      Sign in with Google
    </button>
  </div>

  <h1 class="text-3xl font-bold mb-6">Assign Stores to Seed Markets</h1>
  
  <p class="text-right mb-4">
    Logged in as <span id="userEmail" class="font-bold"></span>
    <button onclick="logout()" class="ml-4 px-4 py-2 bg-gray-700 text-white rounded">
      Logout
    </button>
  </p>

  <div class="bg-white p-6 rounded shadow">
    <table class="w-full border">
      <thead>
        <tr class="bg-gray-200 text-left">          
          <th class="p-3">Market</th>
          <th class="p-3">Store Name</th>
          <th class="p-3">Save</th>
        </tr>
      </thead>

      <tbody id="storeTable"></tbody>
    </table>
  </div>


  <div class="bg-white p-6 rounded shadow mt-8">
    <h2 class="text-xl font-bold mb-4">Current Store → Market Mappings</h2>
  
    <table class="w-full border text-sm">
      <thead>
        <tr class="bg-gray-200 text-left">
          <th class="p-3 border">Store</th>
          <th class="p-3 border">Market</th>
          <th class="p-3 border">Updated By</th>
          <th class="p-3 border">Updated At</th>
          <th class="p-3 border">Actions</th>
        </tr>
      </thead>
  
      <tbody id="mappingTableBody"></tbody>
    </table>
  </div>

  <script>
    window.userRole="admin"; //TODO: remove this after firebase authentication

    // --------- FIREBASE CONFIG -----------
    const firebaseConfig = {
      apiKey: "AIzaSyDiBf4C4K5uoK_PS_kpMtaHLUvxnKLytF0",
      authDomain: "zoom-shops-dev.firebaseapp.com",
      databaseURL: "https://zoom-shops-dev.firebaseio.com",
      projectId: "zoom-shops-dev",
      storageBucket: "zoom-shops-dev.appspot.com",
      messagingSenderId: "664912892527",
      appId: "1:664912892527:web:d38c1d6f14f311ab",
      measurementId: "G-TDJME6Q1L1"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    let idToken = null;  // store JWT token

    document.getElementById("loginBtn").onclick = () => {
      alert("auth");
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    };

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        idToken = await user.getIdToken();
        document.getElementById("userEmail").innerText = user.email;

        // show main app
        document.getElementById("loginDiv").classList.add("hidden");
        document.getElementById("appDiv").classList.remove("hidden");

        loadData();
      } else {
        // show login
        document.getElementById("loginDiv").classList.remove("hidden");
        document.getElementById("appDiv").classList.add("hidden");
      }
    });

    function logout() {
      auth.signOut();
    }

    // --------- FETCH DATA WITH AUTH TOKEN -----------
    async function authFetch(url, options = {}) {
      const headers = options.headers || {};
      headers["Authorization"] = "Bearer " + idToken;

      return fetch(url, { ...options, headers });
    }

    async function loadData() {
      const stores = await fetch("/stores").then(r => r.json());
      const markets = await fetch("/markets").then(r => r.json());

      const marketOptions = markets
        .map(m => `<option value="${m.market_id}">${m.market_name} (ID: ${m.market_id})</option>`)
        .join("");

    const storeOptions = stores
        .map(s => `<option value="${s.estation_name}">${s.estation_name}</option>`)
        .join("");

      const table = document.getElementById("storeTable");

        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td class="p-3 border">
            <select id="market" class="p-2 border rounded w-full">
              <option value="">Select Market</option>
              ${marketOptions}
            </select>
          </td>
          <td class="p-3 border">
            <select id="store" class="p-2 border rounded w-full">
              <option value="">Select Store</option>
              ${storeOptions}
            </select>
          </td>
          <td class="p-3 border">
            <button onclick="saveMapping()"
              class="px-4 py-2 bg-blue-600 text-white rounded">
              Save
            </button>
          </td>
        `;

        table.appendChild(tr);
    }

    async function saveMapping() {
      const storeId = document.getElementById("store").value;
      const marketId = document.getElementById("market").value;

      if (!storeId || !marketId) {
        alert("Select a market first");
        return;
      }

      const body = { estation_name: storeId, market_id: marketId };

      const resp = await fetch("/store-market-map", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      if (resp.ok) {
        console.log(resp.body);
        alert(`Saved mapping: ${storeId} → ${marketId}`);
      } else {
        alert("Error saving mapping");
      }
    }

    async function loadCurrentMappings() {
      const data = await fetch("/store-market-map/current").then(r => r.json());

      const tbody = document.getElementById("mappingTableBody");
      tbody.innerHTML = "";

      if (data.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="p-4 text-center text-gray-500">
              No active mappings found
            </td>
          </tr>`;
        return;
      }

      data.forEach(row => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td class="p-3 border">${row.estation_name}</td>
          <td class="p-3 border">${row.market_id}</td>
          <td class="p-3 border">${row.updated_by}</td>
          <td class="p-3 border">${new Date(row.updated_at).toLocaleString()}</td>
          <td class="p-3 border">
            ${
              window.userRole === "admin"
              ? `
                <button
                  onclick="deleteMapping('${row.estation_name}')"
                  class="px-3 py-1 bg-red-600 text-white rounded text-xs">
                  Delete
                </button>
              `
              : `<span class="text-gray-500 italic">View only</span>`
            }
          </td>
        `;

        tbody.appendChild(tr);
      });
    }

    async function deleteMapping(storeName) {
      if (!confirm(`Delete mapping for ${storeName}?`)) return;

      const resp = await fetch("/store-market-map/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ store_name: storeName })
      });

      if (resp.ok) {
        alert("Mapping deleted");
        loadCurrentMappings();
      } else {
        alert("Delete failed");
      }
    }


    loadData();
    loadCurrentMappings();
  </script>
</body>
</html>
